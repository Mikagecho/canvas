<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマートフォン修理ゲーム V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation;
        }
        .game-container {
            width: 100%;
            max-width: 400px;
            height: 700px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
        }
        .phone-body {
            background-color: #1a1a1a;
            border: 8px solid #000;
        }
        .part, .tray-item, .tool-item {
            position: absolute;
            user-select: none;
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
        }
        .part, .tray-item {
            cursor: grab;
        }
        .part:active, .tray-item:active {
            cursor: grabbing;
        }
        #screw-pile {
            cursor: pointer;
        }
        .dragging {
            opacity: 0.5;
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 100;
        }
        /* --- Part Specific Styles --- */
        .screen {
            background-color: #1e1e1e;
            color: white;
        }
        #cracked-screen-svg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Allows clicks to go through the SVG */
        }
        .battery { background-color: #4a4a4a; color: #ccc; font-weight: bold; }
        .camera { background-color: #1f2937; border: 2px solid #4b5563; }
        .board { background-color: #047857; }
        .new-screen { background-color: #7dd3fc; }
        .new-battery { background-color: #86efac; }
        .new-camera { background-color: #374151; border: 2px solid #9ca3af; }
        .new-board { background-color: #10b981; }

        /* --- Drop Zones & Tools --- */
        .drop-zone-active {
            outline: 3px dashed #3b82f6;
            outline-offset: 4px;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .tool-item {
            cursor: pointer;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-item.selected {
            border-color: #f59e0b;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .screw {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #9ca3af;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .screw:hover {
            background-color: #e5e7eb;
        }

        /* --- Explosion Animation --- */
        .exploding {
            animation: shake 0.2s 4, explode-color 0.8s forwards;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-3deg); }
            75% { transform: translateX(10px) rotate(3deg); }
        }
        @keyframes explode-color {
            0% { background-color: #1a1a1a; }
            50% { background-color: #ef4444; box-shadow: 0 0 50px #f87171;}
            100% { background-color: #111; transform: scale(0.9); opacity: 0.5; box-shadow: none;}
        }

        /* --- Layout & Modal --- */
        .parts-tray, .tools-container {
            border: 2px dashed #9ca3af;
            min-height: 150px;
        }
        #modal.hidden { display: none; }

    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mb-4 text-center">
        <h1 class="text-3xl font-bold text-gray-800">スマホ修理ゲーム V2</h1>
        <div id="timer" class="text-4xl font-bold text-red-600 mt-2">01:00</div>
        <p id="message" class="text-gray-600 mt-2 h-12 p-2 rounded-lg bg-white/50 shadow-inner flex items-center justify-center">ゲームを開始します！</p>
    </div>

    <!-- Main container updated for better responsive behavior -->
    <div class="flex flex-col lg:flex-row items-center lg:items-start justify-center gap-8 w-full max-w-5xl">
        <!-- Game Area -->
        <div class="w-full lg:w-2/5 flex justify-center">
            <div id="game-area" class="game-container relative rounded-3xl phone-body flex items-center justify-center p-4">
                <!-- Parts will be added here -->
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-full lg:w-1/3 flex flex-col gap-6">
            <!-- Tools -->
            <div>
                 <h2 class="text-xl font-bold text-gray-700 mb-2">工具</h2>
                 <div id="tools-container" class="tools-container bg-white p-4 rounded-lg shadow-md flex justify-center items-center gap-4 relative">
                    <!-- Tools will be added here -->
                 </div>
            </div>
            <!-- Parts Tray -->
            <div>
                <h2 class="text-xl font-bold text-gray-700 mb-2">部品トレイ</h2>
                <div id="parts-tray" class="parts-tray bg-white p-4 rounded-lg shadow-md flex flex-col gap-2 relative">
                     <!-- Parts will be added here -->
                </div>
            </div>
             <button id="reset-button" class="mt-2 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                リセット
            </button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm transform transition-all scale-95">
            <h2 id="modal-title" class="text-3xl font-bold mb-4">修理完了！</h2>
            <p id="modal-message" class="text-gray-700 mb-6">素晴らしい！完璧な修理です！</p>
            <button id="modal-close" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg">
                もう一度遊ぶ
            </button>
        </div>
    </div>

    <script>
    // --- DOM Elements ---
    const gameArea = document.getElementById('game-area');
    const partsTray = document.getElementById('parts-tray');
    const toolsContainer = document.getElementById('tools-container');
    const messageEl = document.getElementById('message');
    const timerEl = document.getElementById('timer');
    const resetButton = document.getElementById('reset-button');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseButton = document.getElementById('modal-close');

    // --- Game State ---
    let gameState = {};
    let draggedItem = null;
    let timerInterval = null;
    let timeLeft = 60;

    const initialGameState = {
        selectedTool: null,
        screwsRemoved: false,
        parts: {
            screen: { removed: false, installed: false, in: 'game' },
            battery: { removed: false, installed: false, in: 'game' },
            camera: { removed: false, installed: false, in: 'game' },
            board: { removed: false, installed: false, in: 'game' },
        },
        step: 0,
        messages: [
            "割れたスクリーンをドラッグしてトレイに移動させましょう。",
            "ドライバーを選択して、4つのネジを外してください。",
            "古いバッテリーをトレイに移動させましょう。",
            "古いカメラをトレイに移動させてください。",
            "基板をトレイに移動させましょう。",
            "新しい基板を本体に取り付けてください。",
            "新しいカメラを本体に取り付けてください。",
            "新しいバッテリーを本体に取り付けてください。",
            "ドライバーを選択し、トレイのネジをクリックして本体に取り付けてください。",
            "最後に、新しいスクリーンを取り付ければ完了です！",
            "修理完了です！おめでとうございます！"
        ]
    };
    
    // --- Game Logic ---
    function initGame() {
        if (timerInterval) clearInterval(timerInterval);
        gameState = JSON.parse(JSON.stringify(initialGameState));
        gameArea.innerHTML = '';
        gameArea.classList.remove('exploding');
        partsTray.innerHTML = '';
        toolsContainer.innerHTML = '';

        // Create parts
        createPart('board', '基板', 'board', 'w-[90%] h-[95%]', 5, 5);
        createPart('camera', '■', 'camera', 'w-1/4 h-1/6', 10, 10);
        createPart('battery', 'バッテリー', 'battery', 'w-3/4 h-1/2', 50, 12.5);
        createPart('screen', '', 'screen', 'w-full h-full', 0, 0);

        const screenEl = document.getElementById('screen');
        screenEl.innerHTML = `
            <svg id="cracked-screen-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                <path d="M 10 0 L 40 50 L 20 100" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" fill="none" />
                <path d="M 40 50 L 90 60" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" fill="none" />
                <path d="M 40 50 L 50 40 L 60 45 L 55 30" stroke="rgba(255,255,255,0.15)" stroke-width="0.3" fill="none" />
                <path d="M 90 10 L 40 50" stroke="rgba(255,255,255,0.2)" stroke-width="0.5" fill="none" />
            </svg>
            <span class="text-xl font-bold">割れたスクリーン</span>`;
        
        ['top-2 left-2', 'top-2 right-2', 'bottom-2 left-2', 'bottom-2 right-2'].forEach((pos, i) => {
            const screw = document.createElement('div');
            screw.id = `screw-${i}`;
            screw.className = `screw ${pos} z-10`;
            screw.addEventListener('click', handleScrewClick);
            gameArea.appendChild(screw);
        });

        createTrayPart('new-board', '新しい基板', 'new-board');
        createTrayPart('new-camera', '新しいカメラ', 'new-camera');
        createTrayPart('new-battery', '新しいバッテリー', 'new-battery');
        createTrayPart('new-screen', '新しいスクリーン', 'new-screen');

        const screwdriver = document.createElement('div');
        screwdriver.id = 'screwdriver';
        screwdriver.className = 'tool-item absolute p-2';
        screwdriver.innerHTML = `
            <svg class="w-12 h-12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <title>ドライバー</title>
                <path d="M9 15C9 14.4477 9.44772 14 10 14H14C14.5523 14 15 14.4477 15 15V21C15 21.5523 14.5523 22 14 22H10C9.44772 22 9 21.5523 9 21V15Z" fill="#4A5568"/>
                <path d="M11 2H13V14H11V2Z" fill="#A0AEC0"/>
                <path d="M10 2H14L13.5 0H10.5L10 2Z" fill="#4A5568"/>
            </svg>
        `;
        screwdriver.addEventListener('click', () => selectTool('screwdriver'));
        toolsContainer.appendChild(screwdriver);

        updateMessage();
        modal.classList.add('hidden');
        updateVisibility();
        
        timeLeft = 60;
        timerEl.textContent = "01:00";
        timerEl.classList.remove('text-yellow-500');
        timerInterval = setInterval(updateTimer, 1000);
    }

    function createPart(id, text, type, size, top, left) {
        const part = document.createElement('div');
        part.id = id;
        part.dataset.partType = type;
        part.innerHTML = text;
        part.className = `part ${type} ${size} flex items-center justify-center`;
        part.style.top = `${top}%`;
        part.style.left = `${left}%`;
        part.draggable = true;
        part.addEventListener('dragstart', handleDragStart);
        part.addEventListener('dragend', handleDragEnd);
        gameArea.appendChild(part);
        return part;
    }

    function createTrayPart(id, text, type) {
        const trayPart = document.createElement('div');
        trayPart.id = id;
        trayPart.dataset.partType = type;
        trayPart.textContent = text;
        trayPart.className = `tray-item ${type} p-4 text-center font-semibold text-gray-800 relative`;
        trayPart.draggable = true;
        trayPart.addEventListener('dragstart', handleDragStart);
        trayPart.addEventListener('dragend', handleDragEnd);
        partsTray.appendChild(trayPart);
        return trayPart;
    }

    function updateTimer() {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 10) {
            timerEl.classList.add('text-yellow-500');
        }

        if (timeLeft <= 0) {
            gameOver();
        }
    }

    function gameOver() {
        clearInterval(timerInterval);
        messageEl.textContent = "時間切れ！スマホが爆発しました…";
        gameArea.classList.add('exploding');
        gameArea.innerHTML = '';
        
        setTimeout(() => {
            showModal(
                'ゲームオーバー',
                '残念！時間内に修理できませんでした。',
                '再挑戦する',
                'bg-red-500',
                'hover:bg-red-600'
            );
        }, 800);
    }
    
    function showModal(title, message, buttonText, ...buttonClasses) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalCloseButton.textContent = buttonText;
        
        modalCloseButton.className = "text-white font-bold py-2 px-6 rounded-lg shadow-lg";
        modalCloseButton.classList.add(...buttonClasses);

        modal.classList.remove('hidden');
        modal.querySelector('.transform').classList.add('scale-100');
    }

    function handleDragStart(e) {
        draggedItem = e.target;
        setTimeout(() => e.target.classList.add('dragging'), 0);
        if(e.target.classList.contains('part')) {
            partsTray.classList.add('drop-zone-active');
        } else {
            gameArea.classList.add('drop-zone-active');
        }
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        draggedItem = null;
        partsTray.classList.remove('drop-zone-active');
        gameArea.classList.remove('drop-zone-active');
    }

    function handleDrop(e) {
        e.preventDefault();
        if (!draggedItem) return;

        const dropZone = e.currentTarget;
        const partId = draggedItem.id;
        const partType = draggedItem.dataset.partType;
        const isFromGameArea = draggedItem.parentElement.id === 'game-area';

        if (dropZone.id === 'parts-tray' && isFromGameArea) {
            handleRemovePart(partId, partType);
        }
        else if (dropZone.id === 'game-area' && !isFromGameArea) {
            handleInstallPart(partId, partType);
        }
    }
    
    function handleRemovePart(partId, partType){
        const canRemove = {
            screen: gameState.step === 0,
            battery: gameState.step === 2 && gameState.screwsRemoved,
            camera: gameState.step === 3,
            board: gameState.step === 4
        };
        if(canRemove[partType]) {
            gameState.parts[partType].removed = true;
            gameState.parts[partType].in = 'tray';
            gameState.step++;
            partsTray.appendChild(draggedItem);
            draggedItem.className = `tray-item ${partType} p-4 text-center font-semibold text-gray-800 relative`;
            draggedItem.style = '';
        }
        updateGame();
    }
    
    function handleInstallPart(partId, partType) {
        const canInstall = {
            'new-board': gameState.step === 5,
            'new-camera': gameState.step === 6,
            'new-battery': gameState.step === 7,
            'new-screen': gameState.step === 9 && gameState.screwsRemoved === false
        };
        if(canInstall[partType]) {
             const cleanType = partType.replace('new-','');
             gameState.parts[cleanType].installed = true;
             gameState.parts[cleanType].in = 'game';
             gameState.step++;
             gameArea.appendChild(draggedItem);
             const originalData = {
                board: { text: '基板', size: 'w-[90%] h-[95%]', top: 5, left: 5 },
                camera: { text: '■', size: 'w-1/4 h-1/6', top: 10, left: 10 },
                battery: { text: 'バッテリー', size: 'w-3/4 h-1/2', top: 50, left: 12.5 },
                screen: { text: 'ピカピカ！', size: 'w-full h-full', top: 0, left: 0 },
             }[cleanType];
             
             draggedItem.id = cleanType;
             draggedItem.className = `part ${cleanType} ${originalData.size} flex items-center justify-center`;
             draggedItem.style.top = `${originalData.top}%`;
             draggedItem.style.left = `${originalData.left}%`;
             draggedItem.textContent = originalData.text;
        }
         updateGame();
    }
    
    function handleInstallScrews(e) {
        if (gameState.selectedTool !== 'screwdriver') {
            messageEl.textContent = "ドライバーを選択してください！";
            return;
        }

        if (gameState.step === 8 && gameState.screwsRemoved) {
            e.target.remove();
            document.querySelectorAll('#game-area .screw').forEach(s => {
                s.style.display = 'block';
            });
            
            gameState.screwsRemoved = false;
            gameState.step = 9;
            updateGame();
        }
    }

    function handleScrewClick(e) {
        if (gameState.selectedTool !== 'screwdriver') {
             messageEl.textContent = "ドライバーを選択してください！";
             return;
        }

        if (gameState.step === 1 && !gameState.screwsRemoved) {
            e.target.style.display = 'none';

            let screwPile = document.getElementById('screw-pile');
            if (!screwPile) {
                screwPile = document.createElement('div');
                screwPile.id = 'screw-pile';
                screwPile.dataset.count = 0;
                screwPile.className = 'tray-item p-4 text-center font-semibold text-gray-800 bg-gray-300 relative cursor-pointer';
                screwPile.addEventListener('click', handleInstallScrews);
                partsTray.appendChild(screwPile);
            }

            let count = parseInt(screwPile.dataset.count, 10) + 1;
            screwPile.dataset.count = count;
            screwPile.textContent = `ネジ (${count}/4)`;

            const allScrewsRemoved = Array.from(document.querySelectorAll('#game-area .screw')).every(s => s.style.display === 'none');

            if (allScrewsRemoved) {
                gameState.screwsRemoved = true;
                gameState.step = 2;
                updateGame();
            }
        }
    }
    
    function selectTool(toolId) {
        gameState.selectedTool = toolId;
        document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('selected'));
        document.getElementById(toolId).classList.add('selected');
        updateMessage();
    }
    
    function updateGame() {
        updateMessage();
        updateVisibility();
        checkWinCondition();
    }

    function updateMessage() {
        messageEl.textContent = gameState.messages[gameState.step];
    }

    function updateVisibility() {
        const zIndices = { board: 1, camera: 2, battery: 3, screw: 4, screen: 5 };
        document.querySelectorAll('#game-area .part, #game-area .screw').forEach(el => {
            const id = el.id.includes('screw') ? 'screw' : el.id;
            el.style.zIndex = zIndices[id] || 0;
        });

        document.getElementById('battery').style.visibility = gameState.parts.screen.removed ? 'visible' : 'hidden';
        document.getElementById('camera').style.visibility = gameState.parts.battery.removed ? 'visible' : 'hidden';
        document.getElementById('board').style.visibility = gameState.parts.camera.removed ? 'visible' : 'hidden';
        
        document.querySelectorAll('#game-area .part').forEach(p => {
            if(gameState.parts[p.id]?.installed){
                 p.style.visibility = 'visible';
            }
        });
    }
    
    function checkWinCondition() {
        if (gameState.step === 10) {
            clearInterval(timerInterval);
            gameState.step++;
            updateMessage();
             setTimeout(() => {
                showModal(
                    '修理完了！',
                    `お見事！残り${timeLeft}秒で修理できました！`,
                    'もう一度遊ぶ',
                    'bg-green-500',
                    'hover:bg-green-600'
                );
            }, 500);
        }
    }

    [partsTray, gameArea].forEach(area => {
        area.addEventListener('dragover', (e) => e.preventDefault());
        area.addEventListener('drop', handleDrop);
    });

    resetButton.addEventListener('click', initGame);
    modalCloseButton.addEventListener('click', initGame);

    window.onload = initGame;
    </script>
</body>
</html>
